version: '3'

volumes:
  theatre-db-data:
  elasticsearch-data:

services:
  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./configs:/etc/nginx/conf.d:ro
    ports:
      - "80:80"

  theatre-db:
    image: postgres:16
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - $HOME/postgresql/data:/var/lib/postgresql/data
      - ./database_dump.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  elasticsearch:
    image: elasticsearch:8.6.2
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data


  etl-process:
    image: python:3.11
    volumes:
      - ./etl:/etl
    working_dir: /etl
    command: >
      bash -c "
        ./wait-for-it.sh elasticsearch:9200 --
        python3 -m venv venv &&
        . venv/bin/activate &&
        pip install --upgrade pip &&
        pip install -r requirements.txt &&
        python etl.py
      "
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=theatre-db
      - ELASTICSEARCH_HOST=elasticsearch
    depends_on:
      - theatre-db
      - elasticsearch
